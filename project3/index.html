<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
  <title>Visualizing U.S. Foreign Trade from 1992-2012</title>
  <link rel="stylesheet" media="all" href="css/jquery-jvectormap.css"/>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui.css"/>
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="css/bootstro.css">
  <link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.css">

  <link href="css/nv.d3.css" rel="stylesheet" type="text/css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  
  <!-- import jQuery and jQuery UI -->
  <script src="js/jquery-1.9.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>

  <script src="js/d3.v2.js"></script>

  <script src="js/jquery-jvectormap.js"></script>
  <script src="js/jquery-mousewheel.js"></script>

  <script src="js/lib/jvectormap.js"></script>

  <script src="js/lib/abstract-element.js"></script>
  <script src="js/lib/abstract-canvas-element.js"></script>
  <script src="js/lib/abstract-shape-element.js"></script>

  <script src="js/lib/svg-element.js"></script>
  <script src="js/lib/svg-group-element.js"></script>
  <script src="js/lib/svg-canvas-element.js"></script>
  <script src="js/lib/svg-shape-element.js"></script>
  <script src="js/lib/svg-path-element.js"></script>
  <script src="js/lib/svg-circle-element.js"></script>

  <script src="js/lib/vml-element.js"></script>
  <script src="js/lib/vml-group-element.js"></script>
  <script src="js/lib/vml-canvas-element.js"></script>
  <script src="js/lib/vml-shape-element.js"></script>
  <script src="js/lib/vml-path-element.js"></script>
  <script src="js/lib/vml-circle-element.js"></script>

  <script src="js/lib/vector-canvas.js"></script>
  <script src="js/lib/simple-scale.js"></script>
  <script src="js/lib/numeric-scale.js"></script>
  <script src="js/lib/ordinal-scale.js"></script>
  <script src="js/lib/color-scale.js"></script>
  <script src="js/lib/data-series.js"></script>
  <script src="js/lib/proj.js"></script>
  <script src="js/lib/world-map.js"></script>

  <!-- Import library NVD3 library -->
  <script src="js/nv.d3.js"></script>

  <!-- Import Bootstrap and Bootstro -->
  <script src="js/bootstrap.js"></script>
  <script src="js/bootstro.js"></script>

  <!-- import JSON data -->
  <script src="js/assets/data.js"></script>

  <script src="js/assets/jquery-jvectormap-world-mill-en.js"></script>
<script>
	var mapwidth = 989;
	var mapheight = 481;

  //============================================================
  // Private Variables
  //------------------------------------------------------------

    // 2-letter code of the selected country of the map; default is Canada for the line chart
	var currentcountry = "CA"; 
	var currenthighlight; // code of current country highlighted
	var currflowtype = "B"; // defaults to visualizing trade balance until changed
	var currflowtypestring = "trade balance";
	var currenttime = 0; // current time value, from 0 [Jan 1992] to 25 [Dec 2012]
	var currdata; //the encoded data to be used in the map shading and tooltips.
	
	/*
	var lastsign; // stores the color code of the last line (0 being donor, 1 being receipient)
	var lastwidth; //stores the width of the last line highlihgted
	var lastcountryhighlihgt; // stores the country code of the last line*/
  	var data;
  	var colordata;
	var donationdata;
	var geographiccenters;
	var drawLine; // Takes in two countries and draws a line between them.
	var drawFlow; // Takes in two countries and draws a line between them.
	var drawCountryFlows; //Takes in a country and draws all flows to/from the country
	var mapObject;
	var timeslider; 
	var isStacked = true; // Variable to determine if the bar chart should be stacked or not.
	
	var mapb; // The selected SVG element, used in drawLine.
	var lineChart;
	var barChart;
	
	//variables for slider filter
	var months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
		var monthnames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
		var years = ["1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012"];

	// lookup table for parsing months:
	var monthnums = {JAN:"0",FEB:"1",MAR:"2",APR:"3",MAY:"4",JUN:"5",JUL:"6",AUG:"7",SEP:"8",OCT:"9",NOV:"10",DEC:"11"};

	//variables for scaling
	var logscale=d3.scale.log().domain([0, 41500]).range([0, 30]);

  //============================================================
  // Function Declarations
  //------------------------------------------------------------

	var getcurrData=function(){}; // returns dataset for shading/tooltips based on current time / flowtype
	var getcurrentYear=function(){};
	var getcurrentMonth=function(){};
	var getcurrentMonthname=function(){};
	var updateflowtypeString =  function (){};

	var redraw = function(){};
	var drawPieCharts = function(){};
	// var drawBarChart = function(){};
	var getCountryName = function(){};

	var togglecountry = function (){}; //Called on region select


	//Helper methods to parse the time value:
	getcurrentYear = function(timeVal) {return years[Math.floor(timeVal/12)];}
	getcurrentMonthname =function(timeVal) {return monthnames[timeVal%12];}
	getcurrentMonth =function(timeVal) {return months[timeVal%12];}

	// returns currenttime formatted as 'January 1992'
	function getDateDisplay() {
		return monthnames[monthnums[getcurrentMonth(currenttime)]]+" "+getcurrentYear(currenttime);
	}

	updateflowtypeString = function () {
		var flowtypestring;
		if (currflowtype == "I")
			flowtypestring = "imports";
		else if (currflowtype == "E")
			flowtypestring = "exports";
		else flowtypestring = "trade balance";
		return flowtypestring;						
	}
	
    jQuery.noConflict();
    jQuery(function(){
	var $ = jQuery;

  //============================================================
  // Load External JSON
  //------------------------------------------------------------

	data = JSON.parse(country_data);
	by_use = JSON.parse(by_use);
	goods_vs_services = JSON.parse(goods_vs_services);
	console.log(data);
	console.log(by_use);
	console.log(goods_vs_services);
      
	currdata = getcurrData(currenttime, currflowtype);
	geographiccenters=JSON.parse(countrycenters);

	function getcurrData(timeval, flowtypeval){
		var tmp={};
		var tarray = data[getcurrentYear(timeval)][getcurrentMonth(timeval)];
		for(country in tarray) {
			//try {
				var flowval=tarray[country][flowtypeval];
				tmp[country]=flowval;
			//}
			//catch(err){}
		}
		return tmp;
	}
	
  //============================================================
  // Map Variables
  //------------------------------------------------------------

    $('#map1').vectorMap({
        map: 'world_mill_en',
		regionsSelectable:'true',
		regionsSelectableOne:'true',
		regionStyle: {
			// changes the color of selected countries
			selected: {
				fill: "#ffbb4d"
			}
		},
		backgroundColor: '#fff'/*'#132131' '#003D1F'*/,
		onViewportChange: function(e, s){redraw(currflowtype,0,1);},
		onRegionSelected: function(e, c, s, sa){togglecountry(e,c,s,sa);},
		focusOn: {
          x: 0.5,
          y: 0.5,
          scale: 1
        },
		// onRegionOver: function(event, code){
			// if(donationdata[currentcountry]!=undefined){
			// 	if(donationdata[currentcountry][code]!=undefined)
			// 	{
			// 		highlightcolor=3;
			// 		if(donationdata[currentcountry][code]>0){lastsign=1;}else{lastsign=0;highlightcolor=4;}
			// 	if(donationdata[currentcountry][code]!=0)
			// 	{drawFlow(currentcountry, code, getWidth(donationdata[currentcountry][code])+1, highlightcolor);}
			// 	}
			// }
			// else if(recipientdata[currentcountry]!=undefined){
			// 	if(recipientdata[currentcountry][code]!=undefined)
			// 	{
			// 		highlightcolor=4;
			// 		if(recipientdata[currentcountry][code]>0){lastsign=0;}else{lastsign=1;highlightcolor=3;}
			// 		if(recipientdata[currentcountry][code]!=0)
			// 		{drawFlow(currentcountry, code, getWidth(recipientdata[currentcountry][code])+1, highlightcolor);}
			// 	}
			// }
			
		// },
		onRegionOut:function(event, code){
			redraw(currflowtype,0,1);
//			clearHighlights();
		},
		onRegionLabelShow: function(event, label, code){
			// if there is no selection or if the country mouseovered is the 'select' country
			/*
			if(currentcountry==undefined || currentcountry==code){ 
				if(netodadata.net_oda[code]!=undefined)
				{
					label.html(''+label.html()+'<br>'+
  					'Net ODA (to/from all countries):'+' $'+netodadata.net_oda[code]+' mil USD');
				}
			}			
			if(donationdata[currentcountry]!=undefined){
				if(donationdata[currentcountry][code]!=undefined)
				{
    				label.html(''+label.html()+'<br>'+
      					'Net ODA provided by '+mapObject.mapData.paths[currentcountry].name+': $'+donationdata[currentcountry][code]+' mil USD');
				}
			}
			if(recipientdata[currentcountry]!=undefined){
				if(recipientdata[currentcountry][code]!=undefined)
				{
					label.html(''+label.html()+'<br>'+
      					'Net ODA received from '+	label.html() + ': $'+recipientdata[currentcountry][code]+' mil USD');
				}
			}
			*/	
			if (code == "US"){}
			else if (currdata[code]!= undefined)
			{						
				label.html(''+label.html()+'<br>'+
      			'Net '+currflowtypestring +' with '+	label.html() + ': $'+currdata[code]+' mil USD');
			}
			else {
			label.html(''+label.html()+'<br>'+
      			'No data on '+currflowtypestring +' available.');				
			}
		},
        series: {
          regions: [{
			scale: ['#d6e3ff', '#003eb8', '#ff9200','#fdfa8c'],	
            setNormalizeFunction: 'polynomial',
            values: currdata
        }]
        }
	});

	//get jVectorMap Object  
	mapObject = $('#map1').vectorMap('get', 'mapObject');

	//get SVG element	
	var  mapb=d3.select("#aidmap");
	redraw(currflowtype,1,1); // initialize the flows
  
	togglecountry=function(e, code, isSelected, selectedarray) {
		// only do something if we select a different country
		if (currentcountry != code) {
			currentcountry=code;
			console.log(currentcountry);
			clearLineChart();
			drawLineChart('chart2 svg');

		// TODO: draw line chart here
		}
		//redraw(currflowtype,1,1);
	}
	
  //============================================================
  // Drawing Flow Lines
  //------------------------------------------------------------

	drawFlow = function(country2, width, colorcode,animation){
		lat1 = geographiccenters["US"].Lat;
		lng1 = geographiccenters["US"].Lng;
		lat2 = geographiccenters[country2].Lat;
		lng2 = geographiccenters[country2].Lng;

		//Test if jvectormaps actually has this country.
		if(mapObject.mapData.paths[country2].name!=undefined) {
			drawLine(lat1,lng1,lat2,lng2, width,colorcode,animation);
		}
	}
	
	drawCountryFlows=function(flowtype, animation) {
		var country;
		var flowarray;
		var factor; //negative factor to multiply for recipient array
		if (donationdata[countrytag]==undefined) {
			flowarray=recipientdata[countrytag];
			factor=-1;
		}
		else {
			flowarray = donationdata[countrytag];
			factor=1;
		}
		/*
	var temp = data[getcurrentYear(currenttime)][getcurrentMonth(currenttime)];
	console.log(temp);


		for(country in flowarray) {
			try {
				var flowval=flowarray[country]*factor;
				if (flowval>0) {
					drawFlow(countrytag, country, getWidth(flowval),1,animation); //draw donor lines
				}
				else {
					drawFlow(countrytag, country, getWidth(flowval),0,animation); // draw recipient lines
				}
			}
			catch(err){}
		}*/
	}
	
	function getWidth(flowval){
		var flow= Math.abs(flowval);
		if(flow<=5)
		return .3;
		else 
		return logscale(flow);
	}
		/*function updateScale(){
			if(currflowtype = "I")
			{scale.domain([0, 40500]);}
			else if (currflowtype = "E")
			{scale.domain([0, 26500]);}
			else if (currflowtype = "B")
			{scale.domain([0, 30000]);}
		}*/
		
	function clearLines() {
		elemarray=document.getElementsByClassName("connection")
		if(elemarray!=[])
		{
			while (elemarray.length>0)
			{
				elemarray[0].remove();
			}
		}
	}
	/*function redrawshading(){
		$('#map1').vectorMap('set', 'values', currentdata);
	}*/
	function redraw(flowtype,animation,clear) {

	// if (clear==1){clearLines();}
	// // console.log("Redrawn!");
	// 		var flowarray = data[getcurrentYear(currenttime)][getcurrentMonth(currenttime)];
	// 	for(country in flowarray) {
	// 		/*console.log(country);
	// 		console.log(flowtype);*/
	// 		try {
	// 			var flowval=flowarray[country][flowtype];
	// 			//console.log(flowval);
	// 			if (flowval>0) {
	// 				drawFlow(country, getWidth(flowval),1,animation); //draw export lines
	// 			}
	// 			else {
	// 				drawFlow(country, getWidth(flowval),0,animation); // draw import lines
	// 			}
	// 		}
	// 		catch(err){}
	// 	}
	// 	//if(currentcountry!=undefined)
	// 	//{
	// 		//drawCountryFlows(flowtype,animation);
	// 	//}
	}

    $('#focus-current').click(function(){
    	if (currentcountry != undefined) {
        	$('#map1').vectorMap('set', 'focus', currentcountry);
        }
    });
    $('#focus-init').click(function(){
        $('#map1').vectorMap('set', 'focus', 1, 0, 0);
		mapObject.clearSelected('regions');
		currentcountry=undefined;
    });

	// drawLine=function(lat1,lndrawg1,lat2,lng2,width,colorcode,animation) {
	// 	var Lpoint1=mapObject.latLngToPoint(lat1, lng1);
	// 	var Lpoint2=mapObject.latLngToPoint(lat2, lng2);
	
	// 	if(colorcode==0) { // recipient
	// 		weightx=.1;
	// 		weighty=.05;
	// 		shifty=50;
	// 		var color="#FF4E50";
	// 	} else if(colorcode==1) { // donor
	// 		weightx=.9; //higher it is, the closer the weight is to the first point
	// 		weighty=.65; //same, for y
	// 		shifty=-100;
	// 		var color="#7efff4";
	// 	}
	// 	else if(colorcode==3){// highlight donor
	// 		weightx=.9; //higher it is, the closer the weight is to the first point
	// 		weighty=.65; //same, for y
	// 		shifty=-100;
	// 		var color="white";
	// 	}
	// 	else if(colorcode==4)
	// 	{ // highlight recipient
	// 		weightx=.1;
	// 		weighty=.05;
	// 		shifty=50;
	// 		var color="white";
	// 	}

	// 	weightx=weightx*Lpoint1.x+(1-weightx)*Lpoint2.x;
	// 	weighty=weighty*Lpoint1.y+(1-weighty)*Lpoint2.y+shifty;
		
	// 	if(colorcode==0&&animation==1)//recipient
	// 	{
	// 		var string = "M"+Lpoint2.x+","+Lpoint2.y+" "+"Q"+weightx+","+weighty+" "+Lpoint1.x+","+Lpoint1.y;
	// 	}
	// 	else // donor
	// 	{
	// 		var string = "M"+Lpoint1.x+","+Lpoint1.y+" "+"Q"+weightx+","+weighty+" "+Lpoint2.x+","+Lpoint2.y;
	// 	}

	// 	if(animation==1)
	// 	{
	// 		var totalLength=Math.pow(Math.pow(Lpoint1.x-Lpoint2.x,2)+Math.pow(Lpoint1.y-Lpoint2.y,2),.5)
	//         mapb.append("svg:path")
	// 				.attr('d', string)
	// 				.attr('class', 'connection').attr('fill', 'none')
	//     	.attr('stroke', color)
	//     	.attr('stroke-width', width)
	// 		.attr('stroke-linecap', "butt")
	// 		.attr('opacity', '.50')
	// 		.attr('pointer-events', 'none')
	// 		.attr("stroke-dasharray", totalLength + " " + totalLength)
	// 	 	.attr("stroke-dashoffset", totalLength)
	// 	  	.transition()
	// 	    .duration(500)
	// 	    .ease("linear")
	// 	    .attr("stroke-dashoffset", 0);
	// 	}
	// 	else {
	//      	mapb.append("svg:path")
	// 		.attr('d', string)
	// 		.attr('class', 'connection').attr('fill', 'none')
	//     	.attr('stroke', color)
	//     	.attr('stroke-width', width)
	// 		.attr('stroke-linecap', "butt")
	// 		.attr('opacity', '.50')
	// 		.attr('pointer-events', 'none');
	// 	}
	// }

	function clearBarChart() {
		// saves the current state of the bar chart for continuity
		isStacked = barChart.state().stacked;
		$('#chart svg').empty();
	}

	function clearLineChart() {
		$('#chart1 svg').empty();	
	}

	getCountryName = function(countrycode) {
		mapObject.mapData.paths[countrycode].name;
	}

  //============================================================
  // Slider Stuff
  //------------------------------------------------------------
	timeslider = jQuery( "#slider-range" ).slider({
	     value:0,
			min: 0,
      max: 251,
			orientation: "horizontal",
      range: "min",
      animate: true,
	      slide: function( event, ui ) {
	      	currenttime = ui.value;
	      	currdata=getcurrData(currenttime,currflowtype);	

	      	jQuery( "#timedisplay" ).html(getDateDisplay);;
			redraw(currflowtype,1,1);	
			mapObject.series.regions[0].setValues(currdata);//redrawshading();	
			clearBarChart();
			drawBarChart('#chart svg');	
			clearLineChart();
			drawLineChart('#chart2 svg');
		}
	});
	jQuery( "#timedisplay" ).html("January 1992"); // set the display intitially	
			
	//toolbar javascript:
	jQuery(function() {
	    jQuery( "#beginning" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-start"
	      }
	    });
	    jQuery( "#rewind" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-prev"
	      }
	    });
	    jQuery( "#play" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-play"
	      }
	    })
	    .click(function() {
				playSlider();
	      var options;
	      if ( jQuery( this ).text() === "play" ) {
	        options = {
	          label: "pause",
	          icons: {
	            primary: "ui-icon-pause"
	          }
	        };
	      } else {
	        options = {
	          label: "play",
	          icons: {
	            primary: "ui-icon-play"
	          }
	        };
	      }
	      jQuery( this ).button( "option", options );
	    });
	    jQuery( "#stop" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-stop"
	      }
	    })
	    .click(function() {
	      jQuery( "#play" ).button( "option", {
	        label: "play",
	        icons: {
	          primary: "ui-icon-play"
	        }
	      });
	    });
	    jQuery( "#forward" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-next"
	      }
	    });
	    jQuery( "#end" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-end"
	      }
	    });
	    jQuery( "#shuffle" ).button();
	    jQuery( "#repeat" ).buttonset();
	  });
		
		$("#play").click(function() {
	  if (play==false)
		{
			play==true;
		}
		else
		{play==false;		
		}
	});
	
	 //============================================================
  // Player Stuff
  //------------------------------------------------------------
	
	function playSlider(){
		console.log("played");
		jQuery("#slider-range" ).val("30");
//jQuery("#slider-range" ).slider('refresh');

	};
	
	
});
	
	
	
	// Event handler for checking radio buttons
	jQuery(document).ready(function($) {
		$("input[name='chartselection']").change(function() {
			drawPieCharts();
		});
	});

  </script>
</head>
<!--
  //============================================================
  // HTML
  //============================================================-->

<body>
<div id="pagebackground">
	<div id="headerbar">
		<h1 class='bootstro' 
        	data-bootstro-content="Because bootstrap rocks. Life before bootstrap was sooo miserable"
        	data-bootstro-width="400px" 
        	data-bootstro-placement='bottom' data-bootstro-step='0'>
		<div id="headercontent">
			<img src ="images/Header.png">
		</div>
		</h1>
      	<!--<span id="videodesc"><h3>Project video located <a href="video.html">here.</a></h3></span>-->
    </div>
	<div id="wrapper">
		
	    <div id="map1"></div>
	    <div id="chartwrapper">
	    	<div id="charttitle">U.S. Imports and Exports By Use</div>
	        <div id="chart">
	    		<svg></svg>
	        </div>
	    </div>
	    <div id="timeline">
			<p>
		    <div id="timedisplay"></div>
			</p>
				<div id="slider-range"></div>
		      
			      <!-- taken from http://jqueryui.com/button/#toolbar -->
			      <div id="toolbar" class="ui-widget-header ui-corner-all">
					  <!--<button id="beginning">go to beginning</button>-->
					  <button id="rewind">rewind</button>
					  <button id="play">play</button>
					  <!--<button id="stop">stop</button>-->
					  <button id="forward">fast forward</button>
					  <!--<button id="end">go to end</button>-->

					  <input type="checkbox" id="shuffle" /><label for="shuffle">Start Over</label>
					  <div id = "mapcontrols">
				  		<button id="focus-init">Reset Map</button>
				  		<button id="focus-current">Focus on Current Country</button>
				  	</div>
				</div>
			</div>
	    <div id="chart2"><svg></svg></div>
  	</div> <!-- End wrapper -->
  	<div id="footer">
  		<div id="footerbody">
			<span>Data Source: U.S. Census Bureau | Powered by JVectorMap and NVD3.js</span>
		</div>
    </div>
</div><!-- End pagebackground-->

<script>

  //============================================================
  // Bar Chart Stuff (adapted from nvd3.org)
  //------------------------------------------------------------

	function getByUseDatum(attr, flowtype) {
		var year = getcurrentYear(currenttime);
	  	var month = getcurrentMonth(currenttime);
	  	var str = "by_use[\"" + year + "\"][\"" + month + "\"][\"" + flowtype + "\"][\"" + attr + "\"]";
	  	return eval(str);
	}

	function drawBarChart(container) {
	  barChart = nv.models.multiBarChart(isStacked);
	  d3.select(container).datum([
	    {
	      key: "Capital Goods",
	      color: "#b89a7b",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("capital_goods", "I") },
	          { x : "Exports", y : getByUseDatum("capital_goods", "E") }
	        ]
	    },
	    {
	      key: "Industrial Supplies",
	      color: "#d95d50",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("industrial", "I") },
	          { x : "Exports", y : getByUseDatum("industrial", "E") }
	        ]
	    },
	    {
	      key: "Consumer Goods",
	      color: "#9bbaac",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("consumer_goods", "I") },
	          { x : "Exports", y : getByUseDatum("consumer_goods", "E") }
	        ]
	    },
	    
	    {
	      key: "Automotive Vehicles",
	      color: "#d8d8d8",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("vehicles", "I") },
	          { x : "Exports", y : getByUseDatum("vehicles", "E") }
	        ]
	    },
	    {
	      key: "Foods, Feeds",
	      color: "#f2d649",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("foods", "I") },
	          { x : "Exports", y : getByUseDatum("foods", "E") }
	        ]
	    },
	    {
	      key: "Other Goods",
	      color: "#f47835",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("other", "I") },
	          { x : "Exports", y : getByUseDatum("other", "E") }
	        ]
	    }
	  ]).transition().duration(0).call(barChart);
	};

  //============================================================
  // Line Chart Stuff (adapted from nvd3.org)
  //------------------------------------------------------------

	function drawLineChart(container) {
		var year = getcurrentYear(currenttime);
	  	var month = getcurrentMonth(currenttime);
		nv.addGraph(function() {  
		   console.log(currenttime);
		   lineChart = nv.models.cumulativeLineChart(currenttime)
		             .x(function(d) { return d[0] })
		             .y(function(d) { return d[1]/100 })
		             .color(d3.scale.category10().range())
		             .clipVoronoi(false);

		   lineChart.xAxis
		      .tickFormat(function(d) {
		          return d3.time.format('%x')(new Date(d))
		        });

		  lineChart.yAxis
		      .tickFormat(d3.format(',.1%'));

		  d3.select('#chart2 svg')
		      // .datum(cumulativeTestData())
		      .datum(generateLineChartData())
		    //.transition().duration(500)
		      .call(lineChart);

		  //TODO: Figure out a good way to do this automatically
		  nv.utils.windowResize(lineChart.update);
		  //nv.utils.windowResize(function() { d3.select('#chart1 svg').call(chart) });


		  lineChart.dispatch.on('stateChange', function(e) { nv.log('New State:', JSON.stringify(e)); });

		  return lineChart;
		});	
	}

	function generateLineChartData() {
		var importData = [];
		var exportData = [];

		// Looping through data
		// for each year:
		for (var i = 0; i < years.length; i++) {
			// for each month:
			for (var j = 0; j < months.length; j++) {

				// the numeric import and export values for currentcountry for the specified year and month
				try {
					var importval = data[years[i]][months[j]][currentcountry]["I"];
					var exportval = data[years[i]][months[j]][currentcountry]["E"];
				}
				// if no data is available for this year/month, default to zero
				catch(err) {
					var importval = 0;
					var exportval = 0;
				}	
				// the date value formatted like 'year#, month#'
				var date_object = new Date(years[i], j);
				var date = date_object.getTime();

				// add a data point to importData + exportData
				importData.push([date, importval]);
				exportData.push([date, exportval]);
			}
		}
		return [
		{
			key: "Imports",
			values: importData
		},
		{
			key: "Exports",
			values: exportData
		}
		]
	}

	jQuery(document).ready(function() {
		bootstro.start();
		drawBarChart('#chart svg');
		drawLineChart('#chart2 svg');
	});
</script>  
</body>
</html>