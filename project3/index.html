<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
  <title>The Age of Globalization</title>
  <link rel="stylesheet" media="all" href="css/jquery-jvectormap.css"/>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="stylesheet" type="text/css" href="css/jquery-ui.css"/>
  <link href="css/nv.d3.css" rel="stylesheet" type="text/css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  
  <!-- import jQuery and jQuery UI -->
  <!--	
  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
  <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
  -->
  
  <script src="js/jquery-1.9.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <!-- INCLUDING v3 messes with the stacked bar graph somehow -->
  <!--<script src="js/d3.v3.min.js"></script>-->
  <script src="js/d3.v2.js"></script>
  <script src="js/jquery-jvectormap.js"></script>
  <script src="js/jquery-mousewheel.js"></script>

  <script src="js/lib/jvectormap.js"></script>

  <script src="js/lib/abstract-element.js"></script>
  <script src="js/lib/abstract-canvas-element.js"></script>
  <script src="js/lib/abstract-shape-element.js"></script>

  <script src="js/lib/svg-element.js"></script>
  <script src="js/lib/svg-group-element.js"></script>
  <script src="js/lib/svg-canvas-element.js"></script>
  <script src="js/lib/svg-shape-element.js"></script>
  <script src="js/lib/svg-path-element.js"></script>
  <script src="js/lib/svg-circle-element.js"></script>

  <script src="js/lib/vml-element.js"></script>
  <script src="js/lib/vml-group-element.js"></script>
  <script src="js/lib/vml-canvas-element.js"></script>
  <script src="js/lib/vml-shape-element.js"></script>
  <script src="js/lib/vml-path-element.js"></script>
  <script src="js/lib/vml-circle-element.js"></script>

  <script src="js/lib/vector-canvas.js"></script>
  <script src="js/lib/simple-scale.js"></script>
  <script src="js/lib/numeric-scale.js"></script>
  <script src="js/lib/ordinal-scale.js"></script>
  <script src="js/lib/color-scale.js"></script>
  <script src="js/lib/data-series.js"></script>
  <script src="js/lib/proj.js"></script>
  <script src="js/lib/world-map.js"></script>

  <!-- Import library NVD3 library for stacked bar chart -->
  <script src="js/nv.d3.js"></script>

  <!-- import JSON data -->
  <script src="js/assets/data.js"></script>

  <script src="js/assets/jquery-jvectormap-world-mill-en.js"></script>
  <!--
  <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?2.1.3"></script>
  -->

<script>
	var mapwidth = 989;
	var mapheight = 481;

	//Current variables

	var currentcountry; //selected country of the map
	var currenthighlight; // code of current country highlighted
	var currflowtype = "B"; // defaults to visualizing trade balance until changed
	var currflowtypestring = "trade balance";
	var currenttime=0; // current time value, from 0 [Jan 1989] to 239 [Dec 2012]
	var currdata; //the encoded data to be used in the map shading and tooltips.
	
	/*
	var lastsign; // stores the color code of the last line (0 being donor, 1 being receipient)
	var lastwidth; //stores the width of the last line highlihgted
	var lastcountryhighlihgt; // stores the country code of the last line*/
  	var data;
  	var colordata;
	var donationdata;
	var geographiccenters;
	
	var mapb; // The selected SVG element, used in drawLine.
	
	//variables for slider filter
	var months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
		var monthnames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
		var years = ["1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012"];

	//variables for scaling
	var logscale=d3.scale.log().domain([0, 41500]).range([0, 30]);
	//Functions: helper method.
	var getcurrData=function(){}; // returns dataset for shading/tooltips based on current time / flowtype
	var getcurrentYear=function(){};
	var getcurrentMonth=function(){};
	var getcurrentMonthname=function(){};
	var updateflowtypeString =  function (){};

	var redraw = function(){};
	var drawPieCharts = function(){};
	// var drawBarCharts = function(){};
	var getCountryName = function(){};

	var togglecountry = function (){}; //Called on mouseover
	var drawLine; // Takes in two countries and draws a line between them.
	var drawFlow; // Takes in two countries and draws a line between them.
	var drawCountryFlows; //Takes in a country and draws all flows to/from the country
	var mapObject;
	
    jQuery.noConflict();
    jQuery(function(){
	var $ = jQuery;
	data = JSON.parse(country_data);
	by_use = JSON.parse(by_use);
	goods_vs_services = JSON.parse(goods_vs_services);
	console.log(data);
	console.log(by_use);
	console.log(goods_vs_services);
      
	currdata = getcurrData(currenttime, currflowtype);
	geographiccenters=JSON.parse(countrycenters);

	function getcurrData(timeval, flowtypeval){
		var tmp={};
		var tarray = data[getcurrentYear(timeval)][getcurrentMonth(timeval)];
		for(country in tarray) {
			//try {
				var flowval=tarray[country][flowtypeval];
				tmp[country]=flowval;
			//}
			//catch(err){}
		}
		return tmp;
	}
	
	updateflowtypeString = function () {
		var flowtypestring;
		if (currflowtype == "I")
			flowtypestring = "imports";
		else if (currflowtype == "E")
			flowtypestring = "exports";
		else flowtypestring = "trade balance";
		return flowtypestring;						
	}
	
    $('#map1').vectorMap({
        map: 'world_mill_en',
		regionsSelectable:'true',
		regionsSelectableOne:'true',
		regionStyle: {
			// changes the color of selected countries
			selected: {
				fill: "#ffbb4d"
			}
		},
		backgroundColor: '#fff'/*'#132131' '#003D1F'*/,
		onViewportChange: function(e, s){redraw(currflowtype,0,1);},
		onRegionSelected: function(e, c, s, sa){togglecountry(e,c,s,sa);drawPieCharts();},
		focusOn: {
          x: 0.5,
          y: 0.5,
          scale: 1
        },
		onRegionOver: function(event, code){
			// if(donationdata[currentcountry]!=undefined){
			// 	if(donationdata[currentcountry][code]!=undefined)
			// 	{
			// 		highlightcolor=3;
			// 		if(donationdata[currentcountry][code]>0){lastsign=1;}else{lastsign=0;highlightcolor=4;}
			// 	if(donationdata[currentcountry][code]!=0)
			// 	{drawFlow(currentcountry, code, getWidth(donationdata[currentcountry][code])+1, highlightcolor);}
			// 	}
			// }
			// else if(recipientdata[currentcountry]!=undefined){
			// 	if(recipientdata[currentcountry][code]!=undefined)
			// 	{
			// 		highlightcolor=4;
			// 		if(recipientdata[currentcountry][code]>0){lastsign=0;}else{lastsign=1;highlightcolor=3;}
			// 		if(recipientdata[currentcountry][code]!=0)
			// 		{drawFlow(currentcountry, code, getWidth(recipientdata[currentcountry][code])+1, highlightcolor);}
			// 	}
			// }
			
		},
		onRegionOut:function(event, code){
			redraw(currflowtype,0,1);
//			clearHighlights();
		},
		onRegionLabelShow: function(event, label, code){
			// if there is no selection or if the country mouseovered is the 'select' country
			/*
			if(currentcountry==undefined || currentcountry==code){ 
				if(netodadata.net_oda[code]!=undefined)
				{
					label.html(''+label.html()+'<br>'+
  					'Net ODA (to/from all countries):'+' $'+netodadata.net_oda[code]+' mil USD');
				}
			}			
			if(donationdata[currentcountry]!=undefined){
				if(donationdata[currentcountry][code]!=undefined)
				{
    				label.html(''+label.html()+'<br>'+
      					'Net ODA provided by '+mapObject.mapData.paths[currentcountry].name+': $'+donationdata[currentcountry][code]+' mil USD');
				}
			}
			if(recipientdata[currentcountry]!=undefined){
				if(recipientdata[currentcountry][code]!=undefined)
				{
					label.html(''+label.html()+'<br>'+
      					'Net ODA received from '+	label.html() + ': $'+recipientdata[currentcountry][code]+' mil USD');
				}
			}
			*/	
			if (code == "US"){}
			else if (currdata[code]!= undefined)
			{						
				label.html(''+label.html()+'<br>'+
      			'Net '+currflowtypestring +' with '+	label.html() + ': $'+currdata[code]+' mil USD');
			}
			else {
			label.html(''+label.html()+'<br>'+
      			'No data on '+currflowtypestring +' available.');				
			}
		},
        series: {
          regions: [{
			scale: ['#FFE9FF', '#003D59','#660000','#FFC1D6'],	
            setNormalizeFunction: 'polynomial',
            values: currdata
        }]
        }
	});

	//get jVectorMap Object  
	mapObject = $('#map1').vectorMap('get', 'mapObject');

	//get SVG element	
	var  mapb=d3.select("#aidmap");
	redraw(currflowtype,1,1); // initialize the flows
  
	togglecountry=function(e, code, isSelected, selectedarray) {
		currentcountry=code;
		//draw line chart here
		//redraw(currflowtype,1,1);
	}
	
	drawFlow = function(country2, width, colorcode,animation){
		lat1 = geographiccenters["US"].Lat;
		lng1 = geographiccenters["US"].Lng;
		lat2 = geographiccenters[country2].Lat;
		lng2 = geographiccenters[country2].Lng;

		//Test if jvectormaps actually has this country.
		if(mapObject.mapData.paths[country2].name!=undefined) 
		{
			drawLine(lat1,lng1,lat2,lng2, width,colorcode,animation);
		}
	}
	
	drawCountryFlows=function(flowtype, animation) {
		var country;
		var flowarray;
		var factor; //negative factor to multiply for recipient array
		if (donationdata[countrytag]==undefined)
		{
			flowarray=recipientdata[countrytag];
			factor=-1;
		}
		else 
		{
			flowarray = donationdata[countrytag];
			factor=1;
		}
		/*
	var temp = data[getcurrentYear(currenttime)][getcurrentMonth(currenttime)];
	console.log(temp);


		for(country in flowarray) {
			try {
				var flowval=flowarray[country]*factor;
				if (flowval>0) {
					drawFlow(countrytag, country, getWidth(flowval),1,animation); //draw donor lines
				}
				else {
					drawFlow(countrytag, country, getWidth(flowval),0,animation); // draw recipient lines
				}
			}
			catch(err){}
		}*/
	}
	
	function getWidth(flowval){
		var flow= Math.abs(flowval);
		if(flow<=5)
		return .3;
		else 
		return logscale(flow);
	}
		/*function updateScale(){
			if(currflowtype = "I")
			{scale.domain([0, 40500]);}
			else if (currflowtype = "E")
			{scale.domain([0, 26500]);}
			else if (currflowtype = "B")
			{scale.domain([0, 30000]);}
		}*/
		
	function clearLines() {
		elemarray=document.getElementsByClassName("connection")
		if(elemarray!=[])
		{
			while (elemarray.length>0)
			{
				elemarray[0].remove();
			}
		}
	}
	/*function redrawshading(){
		$('#map1').vectorMap('set', 'values', currentdata);
	}*/
	function redraw(flowtype,animation,clear) {
	if (clear==1){clearLines();}
	// console.log("Redrawn!");
			var flowarray = data[getcurrentYear(currenttime)][getcurrentMonth(currenttime)];
		for(country in flowarray) {
			/*console.log(country);
			console.log(flowtype);*/
			try {
				var flowval=flowarray[country][flowtype];
				//console.log(flowval);
				if (flowval>0) {
					drawFlow(country, getWidth(flowval),1,animation); //draw export lines
				}
				else {
					drawFlow(country, getWidth(flowval),0,animation); // draw import lines
				}
			}
			catch(err){}
		}
		//if(currentcountry!=undefined)
		//{
			//drawCountryFlows(flowtype,animation);
		//}
	}

    $('#focus-current').click(function(){
    	if (currentcountry != undefined) {
        	$('#map1').vectorMap('set', 'focus', currentcountry);
        }
    });
    $('#focus-init').click(function(){
        $('#map1').vectorMap('set', 'focus', 1, 0, 0);
		mapObject.clearSelected('regions');
		currentcountry=undefined;
    });

	drawLine=function(lat1,lndrawg1,lat2,lng2,width,colorcode,animation) {
		var Lpoint1=mapObject.latLngToPoint(lat1, lng1);
		var Lpoint2=mapObject.latLngToPoint(lat2, lng2);
	
		if(colorcode==0) { // recipient
			weightx=.1;
			weighty=.05;
			shifty=50;
			var color="#FF4E50";
		} else if(colorcode==1) { // donor
			weightx=.9; //higher it is, the closer the weight is to the first point
			weighty=.65; //same, for y
			shifty=-100;
			var color="#7efff4";
		}
		else if(colorcode==3){// highlight donor
			weightx=.9; //higher it is, the closer the weight is to the first point
			weighty=.65; //same, for y
			shifty=-100;
			var color="white";
		}
		else if(colorcode==4)
		{ // highlight recipient
			weightx=.1;
			weighty=.05;
			shifty=50;
			var color="white";
		}

		weightx=weightx*Lpoint1.x+(1-weightx)*Lpoint2.x;
		weighty=weighty*Lpoint1.y+(1-weighty)*Lpoint2.y+shifty;
		
		if(colorcode==0&&animation==1)//recipient
		{
			var string = "M"+Lpoint2.x+","+Lpoint2.y+" "+"Q"+weightx+","+weighty+" "+Lpoint1.x+","+Lpoint1.y;
		}
		else // donor
		{
			var string = "M"+Lpoint1.x+","+Lpoint1.y+" "+"Q"+weightx+","+weighty+" "+Lpoint2.x+","+Lpoint2.y;
		}

		if(animation==1)
		{
			var totalLength=Math.pow(Math.pow(Lpoint1.x-Lpoint2.x,2)+Math.pow(Lpoint1.y-Lpoint2.y,2),.5)
	        mapb.append("svg:path")
					.attr('d', string)
					.attr('class', 'connection').attr('fill', 'none')
	    	.attr('stroke', color)
	    	.attr('stroke-width', width)
			.attr('stroke-linecap', "butt")
			.attr('opacity', '.50')
			.attr('pointer-events', 'none')
			.attr("stroke-dasharray", totalLength + " " + totalLength)
		 	.attr("stroke-dashoffset", totalLength)
		  	.transition()
		    .duration(500)
		    .ease("linear")
		    .attr("stroke-dashoffset", 0);
		}
		else {
	     	mapb.append("svg:path")
			.attr('d', string)
			.attr('class', 'connection').attr('fill', 'none')
	    	.attr('stroke', color)
	    	.attr('stroke-width', width)
			.attr('stroke-linecap', "butt")
			.attr('opacity', '.50')
			.attr('pointer-events', 'none');
		}
	}

	function clearChart () {
		$('#chart svg').empty();
	}

	getCountryName = function(countrycode) {
		mapObject.mapData.paths[countrycode].name;
	}

	//Begin slider code
	jQuery( "#slider-range" ).slider({
	     value:0,
			min: 0,
      max: 251,
			orientation: "horizontal",
      range: "min",
      animate: true,
	      slide: function( event, ui ) {
	        jQuery( "#timedisplay" ).html(getcurrentMonth(ui.value)+", "+getcurrentYear(ui.value));
	      	currenttime = ui.value;
			currdata=getcurrData(currenttime,currflowtype);		
			console.log(currdata);
			redraw(currflowtype,1,1);	
			mapObject.series.regions[0].setValues(currdata);//redrawshading();	
			clearChart();
			drawBarCharts('#chart svg');	
		}
	});
		
	jQuery( "#timedisplay" ).html( "January 1992"); // set the display intitially	
			
	//toolbar javascript:
	jQuery(function() {
	    jQuery( "#beginning" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-start"
	      }
	    });
	    jQuery( "#rewind" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-prev"
	      }
	    });
	    jQuery( "#play" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-play"
	      }
	    })
	    .click(function() {
	      var options;
	      if ( jQuery( this ).text() === "play" ) {
	        options = {
	          label: "pause",
	          icons: {
	            primary: "ui-icon-pause"
	          }
	        };
	      } else {
	        options = {
	          label: "play",
	          icons: {
	            primary: "ui-icon-play"
	          }
	        };
	      }
	      jQuery( this ).button( "option", options );
	    });
	    jQuery( "#stop" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-stop"
	      }
	    })
	    .click(function() {
	      jQuery( "#play" ).button( "option", {
	        label: "play",
	        icons: {
	          primary: "ui-icon-play"
	        }
	      });
	    });
	    jQuery( "#forward" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-next"
	      }
	    });
	    jQuery( "#end" ).button({
	      text: false,
	      icons: {
	        primary: "ui-icon-seek-end"
	      }
	    });
	    jQuery( "#shuffle" ).button();
	    jQuery( "#repeat" ).buttonset();
	  });
		
		$("#play").click(function() {
	  if (play==false)
		{
			play==true;
		}
		else
		{play==false;
		
		}
	});
	
});
	
	//Helper methods to parse the time value:
	getcurrentYear = function(timeVal) {return years[Math.floor(timeVal/12)];}
	getcurrentMonthname =function(timeVal) {return monthnames[timeVal%12];}
	getcurrentMonth =function(timeVal) {return months[timeVal%12];}
	
	// Event handler for checking radio buttons
	jQuery(document).ready(function($) {
		$("input[name='chartselection']").change(function() {
			drawPieCharts();
		});
	});

  </script>
</head>

<body>
<div id="pagebackground">
	<div id="wrapper">
    <div id="headerbar">
      <h1>The Age of Globalization</h1>>
      <h2>CS171 Project by Kevin Sun and Albert Young; Powered by jVectorMap and D3.js</h2>
      <span id="videodesc"><h3>Project video located <a href="video.html">here.</a></h3></span>
    </div>
    <div id="map1"></div>
    <div id="chartwrapper">
    	<h2>Imports and Exports By Use</h2>
        <div id="chart">
    		<svg></svg>
        </div>
    </div>
    <div id="timeline">
		    <p>
		  	<span>Timeline  :</span>
	        <div id="timedisplay"></div>
				</p>
			 
				<div id="slider-range"></div>
	      
		      <!-- taken from http://jqueryui.com/button/#toolbar -->
		      <div id="toolbar" class="ui-widget-header ui-corner-all">
			  <!--<button id="beginning">go to beginning</button>-->
			  <button id="rewind">rewind</button>
			  <button id="play">play</button>
			  <!--<button id="stop">stop</button>-->
			  <button id="forward">fast forward</button>
			  <!--<button id="end">go to end</button>-->
			 
			  <input type="checkbox" id="shuffle" /><label for="shuffle">Start Over</label>
			</div>

		</div>
    
    <div id="footer">
    	
    <!--
		<div id="footercenter">
			<label>
				<br>
				View Distribution of ODA by:
				<form>
					<input type="radio" name="chartselection" id="purpose" value="purpose" checked>Purpose
					<input type="radio" name="chartselection" id="income" value="income">Income
					<input type="radio" name="chartselection" id="region" value="region">Region
				</form>
			</label>
		</div>
    -->
		<div id="footerright">
			<br>
				<button id="focus-init">Reset Map</button>
				<!--<button id="focus-current">Focus on Current Country</button>-->
		</div>
		<br>
		<span>Source: U.S. Census Bureau</span>
    </div>
  </div> <!-- End wrapper -->
  
</div><!-- End pagebackground-->

<script>
	function getByUseDatum(attr, flowtype) {
		var year = getcurrentYear(currenttime);
	  	var month = getcurrentMonth(currenttime);
	  	var str = "by_use[\"" + year + "\"][\"" + month + "\"][\"" + flowtype + "\"][\"" + attr + "\"]";
	  	return eval(str);
	}

	function drawBarCharts(container) {
	  var chart = nv.models.multiBarChart();
	  d3.select(container).datum([
	    {
	      key: "Capital Goods",
	      color: "#b89a7b",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("capital_goods", "I") },
	          { x : "Exports", y : getByUseDatum("capital_goods", "E") }
	        ]
	    },
	    {
	      key: "Industrial Supplies",
	      color: "#d95d50",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("industrial", "I") },
	          { x : "Exports", y : getByUseDatum("industrial", "E") }
	        ]
	    },
	    {
	      key: "Consumer Goods",
	      color: "#9bbaac",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("consumer_goods", "I") },
	          { x : "Exports", y : getByUseDatum("consumer_goods", "E") }
	        ]
	    },
	    
	    {
	      key: "Automotive Vehicles",
	      color: "#d8d8d8",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("vehicles", "I") },
	          { x : "Exports", y : getByUseDatum("vehicles", "E") }
	        ]
	    },
	    {
	      key: "Foods, Feeds",
	      color: "#f2d649",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("foods", "I") },
	          { x : "Exports", y : getByUseDatum("foods", "E") }
	        ]
	    },
	    {
	      key: "Other Goods",
	      color: "#f47835",
	      values:
	        [      
	          { x : "Imports", y : getByUseDatum("other", "I") },
	          { x : "Exports", y : getByUseDatum("other", "E") }
	        ]
	    }
	  ]).transition().duration(500).call(chart);
	};
	jQuery(document).ready(function() {
		drawBarCharts('#chart svg');
	});
</script>  
</body>
</html>